!function(){"use strict";var t=angular.module("storytools.core.mapstory",[]);t.service("stMapConfigStore",function(){function t(t){return"/maps/"+t}function e(e){var r=localStorage.getItem(t(e));return r=null===r?{}:angular.fromJson(r)}function r(e){localStorage.setItem(t(e.id),angular.toJson(e))}function o(){var t=[],e=new RegExp("/maps/(\\d+)$");return Object.getOwnPropertyNames(localStorage).forEach(function(r){var o=e.exec(r);o&&t.push({id:o[1]})}),t}function a(){var t=0,e=o().map(function(t){return t.id});return e.sort(),e.length&&(t=parseInt(e[e.length-1])),t+1}return{listMaps:function(){return o()},loadConfig:function(t){return e(t)},saveConfig:function(t){angular.isDefined(t.id)||(t.id=a()),r(t)}}})}(),function(){"use strict";function t(t){ol.Object.call(this,t),this.map_=new ol.Map({target:t.target,pixelRatio:1}),this.overlay=new ol.FeatureOverlay({map:this.map_,style:n}),this.storyLayers_=new ol.Collection,this.animationDuration_=t.animationDuration||500,this.storyPinsLayer=new r({timeAttribute:"start_time",endTimeAttribute:"end_time",layer:new ol.layer.Vector({source:new ol.source.Vector,style:n})}),this.addStoryPinsLayer()}function e(e){t.call(this,e)}function r(t){t.times&&storytools.core.time.utils.isRangeLike(t.times)&&(t.times=new storytools.core.time.utils.Interval(t.times)),ol.Object.call(this,t);var e;if("VECTOR"===this.get("type"))e=new ol.layer.Vector({source:new ol.source.Vector});else if("HEATMAP"===this.get("type"))e=new ol.layer.Heatmap({radius:t.style.radius,opacity:t.style.opacity,source:new ol.source.Vector});else if("WMS"===this.get("type")){var r={useOldAsInterimTiles:!0};e=this.get("singleTile")===!0?new ol.layer.Image(r):new ol.layer.Tile(r)}else e=t.layer;this.layer_=e}function o(t){r.call(this,t)}var a=angular.module("storytools.core.ogc",[]),n=[new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.1)"}),stroke:new ol.style.Stroke({color:"red",width:1}),image:new ol.style.Circle({radius:10,fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.1)"}),stroke:new ol.style.Stroke({color:"red",width:1})})})];t.prototype=Object.create(ol.Object.prototype),t.prototype.constructor=t,t.prototype.addStoryPinsLayer=function(){this.map_.addLayer(this.storyPinsLayer.getLayer())},t.prototype.setBaseLayer=function(t){this.set("baselayer",t),this.map_.getLayers().forEach(function(t){"background"===t.get("group")&&this.map_.removeLayer(t)},this),this.map_.getLayers().insertAt(0,this.get("baselayer"))},t.prototype.addStoryLayer=function(t){t.storyMap_=this,this.storyLayers_.push(t);var e=this.map_.getLayers().getLength(),r=this;this.map_.getLayers().forEach(function(t){t===r.storyPinsLayer&&(e-=1)}),this.map_.getLayers().insertAt(e,t.getLayer())},t.prototype.getStoryLayers=function(){return this.storyLayers_},t.prototype.getMap=function(){return this.map_},t.prototype.clear=function(){this.map_.getLayers().clear(),this.storyLayers_.clear(),this.addStoryPinsLayer()},t.prototype.animateCenterAndZoom=function(t,e){var r=this.map_.getView();this.map_.beforeRender(ol.animation.pan({duration:this.animationDuration_,source:r.getCenter()})),r.setCenter(t),this.map_.beforeRender(ol.animation.zoom({resolution:r.getResolution(),duration:this.animationDuration_})),r.setZoom(e)},t.prototype.setAllowPan=function(t){this.map_.getInteractions().forEach(function(e){(e instanceof ol.interaction.KeyboardPan||e instanceof ol.interaction.DragPan)&&e.setActive(t)})},t.prototype.setAllowZoom=function(t){var e;this.map_.getControls().forEach(function(t){t instanceof ol.control.Zoom&&(e=t)}),t?this.map_.addControl(new ol.control.Zoom):this.map_.removeControl(e),this.map_.getInteractions().forEach(function(e){(e instanceof ol.interaction.DoubleClickZoom||e instanceof ol.interaction.PinchZoom||e instanceof ol.interaction.DragZoom||e instanceof ol.interaction.MouseWheelZoom)&&e.setActive(t)})},a.constant("StoryMap",t),e.prototype=Object.create(t.prototype),e.prototype.constructor=e,a.constant("EditableStoryMap",e),e.prototype.getState=function(){var t={};t.map={center:this.map_.getView().getCenter(),projection:this.map_.getView().getProjection().getCode(),zoom:this.map_.getView().getZoom(),layers:[]};var e=this.get("id");e>=0&&(t.id=e);var r=this.get("baselayer");if(r){var o=this.get("baselayer").get("state");o.group="background",o.visibility=!0,t.map.layers.push(o)}return this.storyLayers_.forEach(function(e){t.map.layers.push(e.getState())}),t},e.prototype.removeStoryLayer=function(t){this.storyLayers_.remove(t),this.map_.removeLayer(t.getLayer())},r.prototype=Object.create(ol.Object.prototype),r.prototype.constructor=r,r.prototype.getStoryMap=function(){return this.storyMap_},r.prototype.setWMSSource=function(){var t=this.getLayer(),e=this.get("name"),r=this.get("times"),o=this.get("singleTile"),a={LAYERS:e,VERSION:"1.1.0",TILED:!0};if(r&&(a.TIME=new Date(r.start||r[0]).toISOString()),o)t.setSource(new ol.source.ImageWMS({params:a,url:this.get("url"),serverType:"geoserver"}));else{var n,i=this.get("resolutions"),s=this.get("bbox");i&&s&&(n=new ol.tilegrid.TileGrid({extent:s,resolutions:i})),t.setSource(new ol.source.TileWMS({url:this.get("url"),params:a,tileGrid:n,serverType:"geoserver"}))}},r.prototype.getState=function(){var t=this.getProperties();return delete t.features,t},r.prototype.getLayer=function(){return this.layer_},r.prototype.setLayer=function(t){if(this.layer_&&this.storyMap_){var e=this.storyMap_.map_,r=e.getLayers().getArray().indexOf(this.layer_);e.getLayers().setAt(r,t)}this.layer_=t},a.constant("StoryLayer",r),o.prototype=Object.create(r.prototype),o.prototype.constructor=o,a.constant("EditableStoryLayer",o),a.service("stAnnotateLayer",["$http","$q",function(t,e){return{loadCapabilities:function(e){var r="GetCapabilities",o="WMS",a=e.get("url");if("/geoserver/wms"===a){var n=e.get("name"),i=n.split(":");a=a.replace("/geoserver","/geoserver/"+i[0]+"/"+i[1])}return t({method:"GET",url:a,params:{REQUEST:r,SERVICE:o,VERSION:"1.1.1",TILED:!0}}).success(function(t){var r=new owsjs.Jsonix.Context([owsjs.mappings.WMSC_1_1_1]),o=r.createUnmarshaller(),a=o.unmarshalString(t),n=a.value.capability.layer;e.set("latlonBBOX",[parseFloat(n.latLonBoundingBox.minx),parseFloat(n.latLonBoundingBox.miny),parseFloat(n.latLonBoundingBox.maxx),parseFloat(n.latLonBoundingBox.maxy)]);for(var i=a.value.capability.vendorSpecificCapabilities.tileSet,s=0,l=i.length;l>s;++s)if("EPSG:900913"===i[s].srs){e.set("resolutions",i[s].resolutions.split(" "));var u=i[s].boundingBox;e.set("bbox",[parseFloat(u.minx),parseFloat(u.miny),parseFloat(u.maxx),parseFloat(u.maxy)]);break}var c=storytools.core.time.maps.readCapabilitiesTimeDimensions(a),y=e.get("name");y in c&&e.set("times",c[y])})},describeFeatureType:function(e){var r=this,o="DescribeFeatureType",a="WFS",n=e.get("id");return t({method:"GET",url:e.get("url"),params:{SERVICE:a,VERSION:"1.0.0",REQUEST:o,TYPENAME:n}}).success(function(t){var o=new storytools.edit.WFSDescribeFeatureType.WFSDescribeFeatureType,a=o.parseResult(t);a.timeAttribute?e.set("timeAttribute",a.timeAttribute):e.get("timeEndpoint")&&r.getTimeAttribute(e);var i=n.split(":");e.set("typeName",n),e.set("featurePrefix",i[0]),e.set("featureNS",a.featureNS),e.set("geomType",a.geomType),e.set("attributes",a.attributes)})},getTimeAttribute:function(e){return t({method:"GET",url:e.get("timeEndpoint")}).success(function(t){e.set("timeAttribute",t.attribute),t.endAttribute&&e.set("endTimeAttribute",t.endAttribute)})},getStyleName:function(r){if(r.get("canStyleWMS")){return t({method:"GET",url:r.get("path")+"rest/layers/"+r.get("id")+".json"}).success(function(t){r.set("styleName",t.layer.defaultStyle.name)})}return e.when("")},getFeatures:function(e,r){var o=e.get("id"),a=e.get("url")+"?service=WFS&version=1.1.0&request=GetFeature&typename="+o+"&outputFormat=application/json&srsName="+r.getView().getProjection().getCode();return t({method:"GET",url:a}).success(function(t){var r=(e.getLayer(),(new ol.format.GeoJSON).readFeatures(t));e.set("features",r)})}}}]),a.service("stBaseLayerBuilder",function(){return{buildLayer:function(t){if("MapQuest"===t.type)return new ol.layer.Tile({state:t,title:t.title,group:"background",source:new ol.source.MapQuest({layer:t.layer})});if("HOT"===t.type)return new ol.layer.Tile({state:t,title:t.title,group:"background",source:new ol.source.OSM({attributions:[new ol.Attribution({html:'Tiles courtesy of <a href="http://hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>'}),ol.source.OSM.ATTRIBUTION],crossOrigin:null,url:"http://{a-c}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png"})});if("OSM"===t.type)return new ol.layer.Tile({state:t,title:t.title,group:"background",source:new ol.source.OSM});if("MapBox"===t.type){var e=new ol.layer.Tile({state:t,title:t.title,group:"background"}),r=t.name,o=["http://a.tiles.mapbox.com/v1/mapbox.","http://b.tiles.mapbox.com/v1/mapbox.","http://c.tiles.mapbox.com/v1/mapbox.","http://d.tiles.mapbox.com/v1/mapbox."],a=function(t){var e=t;return e[1]<0||e[2]<0?"":o[Math.round(3*Math.random())]+r+"/"+e[0].toString()+"/"+e[1].toString()+"/"+e[2].toString()+".png"};return e.setSource(new ol.source.TileImage({crossOrigin:null,attributions:[new ol.Attribution({html:/^world/.test(r)?"<a href='http://mapbox.com'>MapBox</a> | Some Data &copy; OSM CC-BY-SA | <a href='http://mapbox.com/tos'>Terms of Service</a>":"<a href='http://mapbox.com'>MapBox</a> | <a href='http://mapbox.com/tos'>Terms of Service</a>"})],tileGrid:new ol.tilegrid.TileGrid({origin:[-20037508.34,-20037508.34],resolutions:[156543.03390625,78271.516953125,39135.7584765625,19567.87923828125,9783.939619140625,4891.9698095703125,2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,1.194328566789627,.5971642833948135]}),tileUrlFunction:a})),e}if("WMS"===t.type)return new ol.layer.Tile({group:"background",source:new ol.source.TileWMS({url:t.url,params:t.params})});throw new Error("no type for : "+JSON.stringify(t))}}}),a.service("stEditableLayerBuilder",["$q","stAnnotateLayer","stBaseLayerBuilder",function(t,e){return{buildEditableLayer:function(r,a){var n=new o(r),i=t.defer(),s=[],l=!(r.latlonBBOX&&r.times);l&&s.push(e.loadCapabilities(n));var u=!r.attributes;return u&&s.push(e.describeFeatureType(n)),s.push("VECTOR"!==r.type&&"HEATMAP"!==r.type||r.features?e.getStyleName(n):e.getFeatures(n,a)),t.all(s).then(function(){if(n.get("features")){var t=n.get("times");if(t){var e=t.start||t[0];storytools.core.time.maps.filterVectorLayer(n,{start:e,end:e})}else olLayer.getSource().addFeatures(n.get("features"))}else n.setWMSSource();i.resolve(n)},function(){i.reject(arguments)}),i.promise}}}]),a.service("stLayerBuilder",["$q",function(t){return{buildLayer:function(e){var o=new r(e),a=t.defer();return o.setWMSSource(),a.resolve(o),a.promise}}}]),a.service("stStoryMapBaseBuilder",["stBaseLayerBuilder",function(t){return{defaultMap:function(t){t.getMap().setView(new ol.View({center:[0,0],zoom:3})),this.setBaseLayer(t,{title:"Satellite Imagery",type:"MapQuest",layer:"sat"})},setBaseLayer:function(e,r){var o=t.buildLayer(r);e.setBaseLayer(o)}}}]),a.service("stStoryMapBuilder",["stLayerBuilder","stStoryMapBaseBuilder",function(t,e){return{modifyStoryMap:function(r,o){r.clear();var a=o.tools?storytools.mapstory.MapConfigTransformer.MapConfigTransformer(o):o;a.id>=0&&r.set("id",a.id);for(var n=0,i=a.map.layers.length;i>n;++n){var s=a.map.layers[n];"background"===s.group&&s.visibility===!0?e.setBaseLayer(r,s):t.buildLayer(s,r.getMap()).then(function(t){r.addStoryLayer(t)})}r.getMap().setView(new ol.View({center:a.map.center,zoom:a.map.zoom,projection:a.map.projection}))}}}]),a.service("stEditableStoryMapBuilder",["stStoryMapBaseBuilder","stEditableLayerBuilder",function(t,e){return{modifyStoryLayer:function(t,r){var o=t.getProperties(),a=t.getStoryMap();o.type=r?r:"WMS"===o.type?"VECTOR":"WMS","WMS"===o.type&&delete o.features,e.buildEditableLayer(o,a.getMap()).then(function(e){t.setLayer(e.getLayer()),t.set("type",e.get("type"))})},modifyStoryMap:function(r,o){r.clear();var a=void 0!==o.tools?storytools.mapstory.MapConfigTransformer.MapConfigTransformer(o):o;a.id>=0&&r.set("id",a.id);for(var n=0,i=a.map.layers.length;i>n;++n){var s=a.map.layers[n];"background"===s.group&&s.visibility===!0?t.setBaseLayer(r,s):e.buildEditableLayer(s,r.getMap()).then(function(t){r.addStoryLayer(t)})}r.getMap().setView(new ol.View({center:a.map.center,zoom:a.map.zoom,projection:a.map.projection}))}}}])}(),function(){"use strict";function t(){this.storyPins=[]}var e=angular.module("storytools.core.pins",[]),r=storytools.core.maps.pins;t.prototype.pinsChanged=function(t,e){var r;if("delete"==e){for(r=0;r<t.length;r++)for(var o=t[r],a=0,n=this.storyPins.length;n>a;a++)if(this.storyPins[a].id==o.id){this.storyPins.splice(a,1);break}}else if("add"==e)for(r=0;r<t.length;r++)this.storyPins.push(t[r]);else if("change"!=e)throw new Error("action? :"+e);var i=this.storyPins.map(function(t){return t.start_time>t.end_time?storytools.core.utils.createRange(t.end_time,t.start_time):storytools.core.utils.createRange(t.start_time,t.end_time)});this.storyPinsLayer.set("times",i),this.storyPinsLayer.set("features",this.storyPins)},t.prototype.loadFromGeoJSON=function(t,e){if(t&&t.features){var o=r.loadFromGeoJSON(t,e);this.pinsChanged(o,"add",!0)}},e.service("StoryPinLayerManager",t),e.constant("StoryPin",r.StoryPin),e.service("stAnnotationsStore",["StoryPinLayerManager",function(t){function e(t){return"/maps/"+t+"/annotations"}function r(t){var r=localStorage.getItem(e(t));return r=null===r?[]:JSON.parse(r)}function o(t,r){localStorage.setItem(e(t),(new ol.format.GeoJSON).writeFeatures(r,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))}return{loadAnnotations:function(e,o){return t.loadFromGeoJSON(r(e),o)},deleteAnnotations:function(t){var e=r(),a=t.map(function(t){return t.id});e=e.filter(function(t){return a.indexOf(t.id)<0}),o(e)},saveAnnotations:function(t,e){var a=r(),n=0;a.forEach(function(t){n=Math.max(n,t.id)});var i=[];e.forEach(function(t){"undefined"==typeof t.id&&(t.id=++n);var e=t.clone();void 0!==t.get("start_time")&&e.set("start_time",t.get("start_time")/1e3),void 0!==t.get("end_time")&&e.set("end_time",t.get("end_time")/1e3),i.push(e)}),o(t,i)}}}])}(),function(){"use strict";angular.module("storytools.core.style",["storytools.core.style.ol3StyleConverter","storytools.core.style.svgIcon"])}(),function(){"use strict";var t=angular.module("storytools.core.style.ol3StyleConverter",[]);t.factory("ol3MarkRenderer",["ol3StyleConverter",function(t){return function(e,r){var o=t.getColor("#000000"),a=3,n={color:o,width:a},i=angular.element(t.generateShape({symbol:{shape:e,size:r-a}},new ol.style.Fill(n),new ol.style.Stroke(n)).getImage());return i}}]),t.factory("ol3StyleConverter",["stSvgIcon",function(t){return{generateShapeConfig:function(t,e,r){var o=t.symbol.shape,a=t.symbol.size/2;return"circle"===o?{fill:e,stroke:r,radius:a}:"square"===o?{fill:e,stroke:r,points:4,radius:a,angle:Math.PI/4}:"triangle"===o?{fill:e,stroke:r,points:3,radius:a,angle:0}:"star"===o?{fill:e,stroke:r,points:5,radius:a,radius2:.5*a,angle:0}:"cross"===o?{fill:e,stroke:r,points:4,radius:a,radius2:0,angle:0}:"x"===o?{fill:e,stroke:r,points:4,radius:a,radius2:0,angle:Math.PI/4}:void 0},calculateRotation:function(t,e){return t.symbol&&t.symbol.rotationAttribute?"radians"===t.symbol.rotationUnits?e.get(t.symbol.rotationAttribute):e.get(t.symbol.rotationAttribute)/360*Math.PI:void 0},generateShape:function(e,r,o,a){var n=this.generateShapeConfig(e,r,o);if(n&&a&&(n.rotation=this.calculateRotation(e,a)),e.symbol.graphic){var i=t.getImage(e.symbol.graphic,r.getColor(),o.getColor(),!0);return new ol.style.Icon({src:i.dataURI,rotation:this.calculateRotation(e,a),scale:e.symbol.size/Math.max(i.width,i.height),opacity:e.symbol.opacity})}return"circle"===e.symbol.shape?new ol.style.Circle(n):new ol.style.RegularShape(n)},getText:function(t,e){return t.label&&t.label.attribute?""+e.get(t.label.attribute):void 0},generateText:function(t,e,r){return t.label&&null!==t.label.attribute?new ol.style.Text({fill:new ol.style.Fill({color:t.label.fillColor}),stroke:e,font:t.label.fontStyle+" "+t.label.fontWeight+" "+t.label.fontSize+"px "+t.label.fontFamily,text:this.getText(t,r)}):void 0},getColor:function(t,e){var r=ol.color.asArray(t);return void 0!==e&&(r=r.slice(),r[3]=e/100),"rgba("+r.join(",")+")"},generateCacheKey:function(t,e){var r=this.getText(t,e),o=t.classify&&t.classify.attribute?e.get(t.classify.attribute):void 0,a=t.symbol&&t.symbol.rotationAttribute?e.get(t.symbol.rotationAttribute):void 0;return r+"|"+o+"|"+a},generateStyle:function(t,e){var r,o;this.styleCache_||(this.styleCache_={});var a=JSON.stringify(t);if(this.styleCache_[a]){if(this.styleCache_[a].length)return this.styleCache_[a];if(o=this.generateCacheKey(t,e),this.styleCache_[a][o])return this.styleCache_[a][o]}var n;if(t.stroke){var i;"dashed"===t.stroke.strokeStyle?i=[5]:"dotted"===t.stroke.strokeStyle&&(i=[1,2]),n=new ol.style.Stroke({lineDash:i,color:this.getColor(t.stroke.strokeColor,t.stroke.strokeOpacity),width:t.stroke.strokeWidth})}if(t.classify&&null!==t.classify.attribute){for(var s,l=0,u=t.rules.length;u>l;++l){var c=t.rules[l],y=e.get(t.classify.attribute),p=!1;void 0!==c.value?p=y===c.value:c.range&&(p=y>=c.range.min&&y<=c.range.max),p&&(s=this.generateText(t,n,e),"point"===t.geomType&&c.style.symbol.fillColor?r=[new ol.style.Style({text:s,image:this.generateShape(t,new ol.style.Fill({color:c.style.symbol.fillColor}),n,e)})]:"line"===t.geomType&&c.style.stroke.strokeColor?r=[new ol.style.Style({text:s,stroke:new ol.style.Stroke({color:c.style.stroke.strokeColor,width:2})})]:"polygon"===t.geomType&&c.style.symbol.fillColor&&(r=[new ol.style.Style({text:s,stroke:n,fill:new ol.style.Fill({color:c.style.symbol.fillColor})})]))}r&&(this.styleCache_[a]||(this.styleCache_[a]={}),o=this.generateCacheKey(t,e),this.styleCache_[a][o]=r)}else{var g=new ol.style.Fill({color:this.getColor(t.symbol.fillColor,t.symbol.fillOpacity)});r=[new ol.style.Style({image:this.generateShape(t,g,n,e),fill:g,stroke:n,text:this.generateText(t,n,e)})]}if(r){var f=r[0].getText();f||t.classify&&t.classify.attribute||t.symbol&&t.symbol.rotationAttribute?(this.styleCache_[a]||(this.styleCache_[a]={}),o=this.generateCacheKey(t,e),this.styleCache_[a][o]=r):this.styleCache_[a]=r}return r}}}])}(),function(){"use strict";var t=angular.module("storytools.core.style.svgIcon",[]);t.factory("stSvgIcon",["$cacheFactory","$http","$q","$log",function(t,e,r,o){function a(t,e,r){n.html(t),["path","polygon","circle","ellipse","rect","line","polyline"].forEach(function(t){angular.forEach(n.find(t),function(t){t=angular.element(t);var o={opacity:1},a=t.css("fill")||t.attr("fill")||"";"none"!=a&&"rgb(255, 255, 255)"!=a&&"#ffffff"!=a.toLowerCase()&&(o.fill=e);var n=t.css("stroke")||t.attr("stroke");"none"!=n&&(o.stroke=r),t.css(o)})});var o=n.find("svg"),a=parseInt(o.attr("width")),i=parseInt(o.attr("height"));(isNaN(a)||isNaN(i))&&(o.attr("width",64),o.attr("height",64),a=64,i=64);var s="data:image/svg+xml;base64,"+btoa(n.html());return{dataURI:s,width:a,height:i}}var n=angular.element(document.createElement("div")),i=t("stSvgImage"),s=t("stSvgData");return{getImage:function(t,e,n,l){var u=t+e+n,c=i.get(u),y=r.defer();if(c){if(l)return c;y.resolve(c)}else{if(l){var p=s.get(t);if(p){var g=a(p,e,n);return g.uri=t,i.put(u,g),g}return o.warning("no svg for",t),null}this.getImageData(t).then(function(r){var o=a(r.data,e,n);o.uri=t,i.put(u,o),y.resolve(o)},function(){y.reject("error")})}return y.promise},getImageData:function(t){return e.get(t,{cache:!0}).success(function(e){return s.put(t,e),e}).error(function(){o.warn("error fetching "+t)})}}}])}(),function(){"use strict";var t=angular.module("storytools.core.time.directives",[]);t.directive("stPlaybackControls",function(){return{restrict:"E",templateUrl:"time/playback-controls.html",scope:{timeControls:"="},link:function(t){t.playText="Start",t.loopText="Enable Loop",t.loop=!1,t.next=function(){t.timeControls.next()},t.prev=function(){t.timeControls.prev()},t.$watch("timeControls",function(e,r){e!==r&&(e.on("stateChange",function(){var e=t.timeControls.isStarted();t.started=e,t.playText=e?"Stop":"Start",t.$apply()}),e.on("rangeChange",function(e){t.currentRange=e,t.$apply()}))}),t.play=function(){var e=t.timeControls,r=e.isStarted();r?e.stop():e.start()},t.toggleLoop=function(){var e=t.timeControls;t.loop=e.loop=!e.loop,t.loopText=e.loop?"Disable Loop":"Enable Loop"}}}}),t.directive("stPlaybackSettings",function(){return{restrict:"E",templateUrl:"time/playback-settings.html",scope:{timeControls:"=",playbackOptions:"="},link:function(t){t.optionsChanged=function(){t.timeControls&&t.timeControls.update(t.playbackOptions)}}}})}(),function(){"use strict";var t=angular.module("storytools.core.time",["storytools.core.time.directives","storytools.core.time.services","storytools.core.templates"]);t.filter("isodate",function(){return function(t){return null!==t&&angular.isDefined(t)?angular.isNumber(t)?new Date(t).toISOString():Date.parse(t).toISOString():""}})}(),function(){"use strict";function t(t){function e(t){t=o.getTime(t),null===t||t in a||(a[t]=1)}if(!angular.isArray(t)){var r=t;t=r.getStoryLayers().getArray().filter(function(t){var e=t.get("times");return null!=e}),t.push(r.storyPinsLayer)}var a={},n=null,i=[];if(t.forEach(function(t){var r,a=t.get("times");angular.isArray(a)?(r=o.computeRange(a),a.length&&a.forEach(o.isRangeLike(a[0])?function(t){e(t.start),null===n?n=o.createRange(t):n.extend(t)}:function(t){e(t)}),null!=r.end&&e(r.end)):a&&(r=a,i.push(a)),null===n?n=o.createRange(r):n.extend(r)}),i.length){i.sort(function(t,e){return t.interval-e.interval});for(var s=i[0],l=n.start;l<=n.end;)e(l),l=s.offset(l)}return a=Object.getOwnPropertyNames(a).map(function(t){return parseInt(t)}),a.sort(function(t,e){return t-e})}function e(e,r,o){function a(a){if(null===n.timeControls){var i=t(o.storyMap);if(i.length){var s=r.storyPins;n.timeControls=storytools.core.time.create({annotations:s,storyMap:o.storyMap,data:i,mode:o.storyMap.mode,tileStatusCallback:function(t){e.$broadcast("tilesLoaded",t)}}),n.timeControls.on("rangeChange",function(t){n.currentRange=t})}}else if(a){var l=a();l&&n.timeControls.update(l)}}this.timeControls=null;var n=this;o.storyMap.getStoryLayers().on("change:length",function(){a(function(){var e=t(o.storyMap);return e.length?{data:e}:void 0})});var i=o.storyMap.storyPinsLayer;i.on("change:features",function(){a(function(){var e=t(o.storyMap);return e.length?{annotations:i.get("features"),data:e}:void 0})}),a()}var r=angular.module("storytools.core.time.services",[]),o=storytools.core.time.utils;r.constant("TimeControlsManager",e),r.service("TimeMachine",function(){return{computeTicks:t}})}();